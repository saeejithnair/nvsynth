# nvsynth
NutritionVerse-Synth: Synthetic generation of food scenes for dietary intake estimation

## Set Up for Lavazza

### Install Omniverse
Download Omniverse Installer from https://www.nvidia.com/en-us/omniverse/download/

The easiest way is to download it to your local machine and then `scp` the AppImage onto the desired server.
You can also find an existing copy of the AppImage on `guacamole:/pub2/nrc/omniverse/omniverse-launcher-linux.AppImage`

To install omniverse, simply run the AppImage and follow the installer prompts. 
`./omniverse-launcher-linux.AppImage`

Make sure to install IsaacSim, Omniverse Code, and optionally Omniverse Create. You can install all of these packages through the Nucleus Launcher.

Omniverse should be installed to `/home/$USER/.local/share/ov/`.

The packages should be installed to `/home/$USER/.local/share/ov/pkg`.


### Installation Errors
#### FUSE error upon running the AppImage
`fuse: failed to exec fusermount: No such file or directory`

The solution is to follow the instructions listed on https://github.com/AppImage/AppImageKit/wiki/FUSE#install-fuse

Since `guacamole` runs Ubuntu 22.04, the following commands were executed

* `sudo add-apt-repository universe`
* `sudo apt install libfuse2`
* [**CAUTION**: Only try this if the error hasn't been resolved] `sudo apt-get install fuse3`


### Clone repo
`cd $WORKSPACE`

`git clone git@github.com:saeejithnair/vip-omni.git`

### Create symbolic link to Isaac Sim
`cd $WORKSPACE/vip-omni`

`ln -s /home/$USER/.local/share/ov/pkg/isaac_sim-2022.1.1 isaac_sim`

### Set up conda environment
`cd $WORKSPACE/vip-omni/isaac_sim`

`conda env create --name "${USER}_isaac" --file=environment.yml`

`conda activate "${USER}_isaac"`

`source setup_conda_env.sh`

`export DISPLAY_GPU_ID=2`

`export CUDA_VISIBLE_DEVICES=$DISPLAY_GPU_ID`

### Install Foodverse packages
`cd $WORKSPACE/vip-omni/`

`pip install -e .`

`pip install GitPython`

### Create symbolic link to food assets directory
`cd $WORKSPACE/vip-omni/assets`

`ln -s /pub2/nrc/aging/snair_iccv_data food`

# Data Preprocessing
Once the 2D images are generated, the following scripts need to be run to structure the data and create the desired metadata files:

1. `structure_folder.py`: This script takes the 2D images and structures them into an organized file format for later processing.

```
project
└───2D_Image
│   └───scene_0000
│       │   0000_viewport_1.png
│       │   0000_viewport_2.png
│       │   ...
│       │   0000_viewport_12.png
│   └───scene_0001
│       │   0001_viewport_1.png
│       │   0001_viewport_2.png
│       │   ...
│       │   0001_viewport_12.png
│   └───...
│       │   ...
│   └───scene_50000
│       │   0001_viewport_1.png
│       │   0001_viewport_2.png
│       │   ...
│       │   0001_viewport_12.png
│   
└───masks
│   └───scene_0000
│       │   0000_viewport_1.png
│       │   0000_viewport_2.png
│       │   ...
│       │   0000_viewport_12.png
│   └───scene_0001
│       │   0001_viewport_1.png
│       │   0001_viewport_2.png
│       │   ...
│       │   0001_viewport_12.png
│   └───...
│       │   ...
│   └───scene_50000
│       │   0001_viewport_1.png
│       │   0001_viewport_2.png
│       │   ...
│       │   0001_viewport_12.png
│   
└───metadata
│   └───scene_0000
│       │   0000_viewport_1.json
│       │   0000_viewport_2.json
│       │   ...
│       │   0000_viewport_12.json
│   └───scene_0001
│       │   0001_viewport_1.json
│       │   0001_viewport_2.json
│       │   ...
│       │   0001_viewport_12.json
│   └───...
│       │   ...
│   └───scene_50000
│       │   0001_viewport_1.json
│       │   0001_viewport_2.json
│       │   ...
│       │   0001_viewport_12.json
```

2. `generate_metadata_file.py`: This script uses the metadata folder generated by the previous script to create a dish metadata csv file containing the following fields:

`dish_id, total_calories, total_mass, total_fat, total_carb, total_protein, num_ingrs, (ingr_1_id, ingr_1_name, ingr_1_grams, ingr_1_calories, ingr_1_fat, ingr_1_carb, ingr_1_protein, ...)`

This dish metadata csv file is the same format as that of the Nutrition5k paper with the last 8 fields repeated for every ingredient present in the dish. 
